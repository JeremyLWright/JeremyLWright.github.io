<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.107.0">

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://quiescent.us/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://quiescent.us/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://quiescent.us/favicon-16x16.png">

  
  <link rel="manifest" href="https://quiescent.us/site.webmanifest">

  
  <link rel="mask-icon" href="https://quiescent.us/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://quiescent.us/css/bootstrap.min.css" />

  
  <link rel="stylesheet" href="https://quiescent.us/css/syntax.css" />
  
  
  <title>Property Testing in C&#43;&#43; | The Quiescent Current</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/posts">Posts</a>
    
    <a href="/series">Series</a>
    
    <a href="/tags">Tags</a>
    
    <a href="/about">About</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Property Testing in C++</h1>
<p>
Currently, I'm on a testing kick. One might say tests are shiny. I don't
know if they are really shiny as much as I found another cool use for
uniform_int_distribution<>. A use which, as a side effect, might make me
appear to be a better software developer. (This assumes a negative bug rate is
proportional to better software). I've started playing with Property Testing.
Property Testing is a form of unit testing where the programmers defines
properties, or invariants about the code. A <del>framework</del> library (ok,
seriously its a framework because it calls your code) generates random
constrained inputs and calls your test functions. It's pretty cool, and while
I was playing around with the framework, I found a real bug, related to my
ignorance of C++'s auto type deduction.</p>
<p>Let's steal a simple
example from my CSE 565 Software Verification class: a payroll function. Here
is the specification:</p> <blockquote> <p>Design a function that calculates
payroll for an employee.</p> <h3>Inputs</h3> <p>Employee Id number<br>Number
of Hours</p> <h3>Outputs</h3> <p>Amount to pay employee as a floating point
value.</p> <h3>Constraints</h3> <p>Pay is calculated at $10 for standard time,
$15 for overtime over 40 hours.<br>Overtime starts over 40 hours<br>Maximum
number of hours is 100.</p></blockquote> <p>For this demonstration, I’m using
a C++ port of Haskell’s QuickCheck, CppQuickCheck (<a
title="https://github.com/grogers0/CppQuickCheck"
href="https://github.com/grogers0/CppQuickCheck">https://github.com/grogers0/CppQuickCheck</a>,
my fork and the examples in this post are available here: <a
title="https://github.com/jwright85/CppQuickCheck"
href="https://github.com/jwright85/CppQuickCheck">https://github.com/jwright85/CppQuickCheck</a>).
QuickCheck was designed by John Hughes who has gone on to support a commercial
version of the library for verifying (and validating) automotive requirements
for Volvo (<a title="http://vimeo.com/68331689"
href="http://vimeo.com/68331689">http://vimeo.com/68331689</a>).&nbsp; His
presentations have motivated me to try this testing strategy for my own
programs. Lets start with a quick implementation for our payroll function.
We'll then apply properties against the function until we are satisfied with
the implementation. Although property testing can provide more confidence in
an implementation Dijkstra's famous quote still stands, "Testing shows the
presence, not the absence of bugs."</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">float</span> <span class="nf">payroll</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">size_t</span><span class="p">,</span> <span class="mi">5</span><span class="o">&gt;</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">hours</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">hours</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">out_of_range</span><span class="p">(</span><span class="s">&#34;Hours cannot be greater than 100&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">overtime</span> <span class="o">=</span> <span class="n">hours</span> <span class="o">-</span> <span class="mi">40</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">hours</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">overtime</span> <span class="o">*</span> <span class="mi">15</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This is obviously wrong, but let&rsquo;s suspend that for a moment and think about
properties i.e. invariants we can verify.</p>
<p>The first property verifies that we do not write a negative paycheck. The
return type of the function is float, which supports negative values even
though the output domain of our specification forbids it. Lets write
a property over the valid input range of hours that we don&rsquo;t generate negative
pay.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">PropTestPositivePay</span> <span class="o">:</span> <span class="n">cppqc</span><span class="o">::</span><span class="n">Property</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="n">PropTestPositivePay</span><span class="p">()</span> <span class="o">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">cppqc</span><span class="o">::</span><span class="n">choose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span> <span class="p">{}</span> 
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="nf">check</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="o">&amp;</span>  <span class="n">hours</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">size_t</span><span class="p">,</span> <span class="mi">5</span><span class="o">&gt;</span> <span class="n">id</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">};</span> 
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">uut</span><span class="o">::</span><span class="n">payroll</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">hours</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">()</span> <span class="k">const</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;Pay should be positive&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">classify</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span> <span class="k">const</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span> <span class="n">sstr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">sstr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Hours &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sstr</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="nf">trivial</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="o">&amp;</span>  <span class="n">v</span><span class="p">)</span> <span class="k">const</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>Now the input range of this function is small (101 values) so we could run an exhaustive test, but for larger input domains the random generators can really shine. </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">jwright@phaseshift-linux:~/art/CppQuickCheck/b$ ./examples/testPayroll
</span></span><span class="line"><span class="cl">* Checking property <span class="s2">&#34;Pay should be positive&#34;</span> ...
</span></span><span class="line"><span class="cl">* *** Failed! Falsifiable after <span class="m">32</span> tests <span class="k">for</span> input:
</span></span><span class="line"><span class="cl">*   0: <span class="m">24</span>
</span></span><span class="line"><span class="cl">*
</span></span></code></pre></div><p>Cool it found that an input of 0 will falsify the test. Lets add some more tests.</p>
<p>Let&rsquo;s add a property that verifies for the input range of overtime that the
function doesn’t pay all hours at the $10 rate nor all the hours at the $15
rate. The correct implementation is some mixture of these two.  This
brings me to a subtle point when I first heard of property-testing when
studying Haskell. In my naiveté I thought to myself, &ldquo;If I have a model that
verifies the unit under test, aren&rsquo;t I duplicating the implementation?&rdquo;
Furthermore, if I duplicate the implementation, how can I be sure I&rsquo;m not
making the same bugs twice. One response I found online, “we test our C code
in Erlang. It&rsquo;s unlikely to make the same mistake in two separate languages.”
I was wrong however, you don&rsquo;t have to duplicate the functionality. You can
steer the generator to generate data within a range over which a simple
property will be true. Multiple properties together then test the fuller input
domain without requiring 1 single verifier to duplicate behavior. This
property doesn’t exactly know what the correct payroll is. It isn’t
calculating the correct value, it’s just excluding values that it cannot be.</p>
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">PropTestOvertimeRateHigher</span> <span class="o">:</span> <span class="n">cppqc</span><span class="o">::</span><span class="n">Property</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="n">PropTestOvertimeRateHigher</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">Property</span><span class="p">(</span><span class="n">cppqc</span><span class="o">::</span><span class="n">choose</span><span class="p">(</span><span class="mi">41</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span> <span class="p">{}</span> 
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="nf">check</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="o">&amp;</span>  <span class="n">hours</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">size_t</span><span class="p">,</span> <span class="mi">5</span><span class="o">&gt;</span> <span class="n">id</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">};</span> 
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">pay</span> <span class="o">=</span> <span class="n">uut</span><span class="o">::</span><span class="n">payroll</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">hours</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pay</span> <span class="o">&gt;</span> <span class="n">hours</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span>  <span class="n">pay</span> <span class="o">&lt;</span> <span class="n">hours</span> <span class="o">*</span> <span class="mi">15</span><span class="p">;</span> <span class="c1">//You cannot get paid all overtime or all standard pay
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">()</span> <span class="k">const</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;You cannot get paid all overtime, or all std time&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">classify</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span> <span class="k">const</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span> <span class="n">sstr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">sstr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Hours &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sstr</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="nf">trivial</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="o">&amp;</span>  <span class="n">v</span><span class="p">)</span> <span class="k">const</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">40</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>Following this thought of excluding a range and testing a simpler property,
lets test the payroll without considering overtime. In this case the
calculation is simple so we can provide a full implementation.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">PropTestIgnoreOvertime</span> <span class="o">:</span> <span class="n">cppqc</span><span class="o">::</span><span class="n">Property</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PropTestIgnoreOvertime</span><span class="p">()</span> <span class="o">:</span> <span class="n">Property</span><span class="p">(</span><span class="n">cppqc</span><span class="o">::</span><span class="n">choose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">))</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="nf">check</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="o">&amp;</span>  <span class="n">hours</span><span class="p">)</span> <span class="k">const</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">size_t</span><span class="p">,</span> <span class="mi">5</span><span class="o">&gt;</span> <span class="n">id</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">pay</span> <span class="o">=</span> <span class="n">uut</span><span class="o">::</span><span class="n">payroll</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">hours</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pay</span> <span class="o">==</span> <span class="n">hours</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">()</span> <span class="k">const</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;Not working overtime makes the math easy.&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">classify</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span> <span class="k">const</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span> <span class="n">sstr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">sstr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Hours &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sstr</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="nf">trivial</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="o">&amp;</span>  <span class="n">v</span><span class="p">)</span> <span class="k">const</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">40</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>We run the tests a few times and see the failing test cases. These data are random. Running the test multiple times fails differently, but minimization results in the same or similar values each time to help the programmer debug. So let&rsquo;s fix this code and watch the tests pass to avoid the <a href="http://www.codestrokes.com/2014/08/what-is-a-unit-test/">mockery and scandal of code review</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">float</span> <span class="nf">payroll</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">size_t</span><span class="p">,</span> <span class="mi">5</span><span class="o">&gt;</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">hours</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">hours</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">out_of_range</span><span class="p">(</span><span class="s">&#34;Hours cannot be greater than 100&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">overtime</span> <span class="o">=</span> <span class="n">hours</span> <span class="o">-</span> <span class="mi">40</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">overtime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">hours</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">overtime</span> <span class="o">*</span> <span class="mi">15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">hours</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">* Checking property <span class="s2">&#34;Not working overtime makes the math easy.&#34;</span> ...
</span></span><span class="line"><span class="cl">*** Failed! Falsifiable after <span class="m">1</span> <span class="nb">test</span> and <span class="m">1</span> shrink <span class="k">for</span> input:
</span></span><span class="line"><span class="cl">0: <span class="m">0</span>
</span></span></code></pre></div><p>To be honest, while setting up the tests for this post I fully expected the
tests to start passing and this article would end here. Instead I learned some
real value on using these properties as a debugging and design tool. Let&rsquo;s add
a printf to the code to get a sense what&rsquo;s happening</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">* Checking property <span class="s2">&#34;Not working overtime makes the math easy.&#34;</span> ...
</span></span><span class="line"><span class="cl">Overtime: <span class="m">18446744073709551576</span> &lt;--- Whoa what happened there?
</span></span><span class="line"><span class="cl">*** Failed! Falsifiable after <span class="m">1</span> <span class="nb">test</span> and <span class="m">1</span> shrink <span class="k">for</span> input:
</span></span><span class="line"><span class="cl">0: <span class="m">0</span>
</span></span></code></pre></div><p>Overtime seems to be an unsigned value, and passing in 0 causes the value to wrap around. The rule (<a href="http://scottmeyers.blogspot.com/2013/07/when-decltype-meets-auto.html">http://scottmeyers.blogspot.com/2013/07/when-decltype-meets-auto.html</a>) assures that overtime becomes a size_t since hours is size_t. We can force floating conversion by stating that 40 is a floating point number.</p></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">float</span> <span class="nf">payroll</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">size_t</span><span class="p">,</span> <span class="mi">5</span><span class="o">&gt;</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">hours</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">hours</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">out_of_range</span><span class="p">(</span><span class="s">&#34;Hours cannot be greater than 100&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">overtime</span> <span class="o">=</span> <span class="n">hours</span> <span class="o">-</span> <span class="mf">40.0</span><span class="p">;</span> <span class="c1">//&lt;-- Force implicit floating point cast
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">overtime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">hours</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">overtime</span> <span class="o">*</span> <span class="mi">15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">hours</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">* Checking property <span class="s2">&#34;Pay should be positive&#34;</span> ...
</span></span><span class="line"><span class="cl">+++ OK, passed <span class="m">100</span> tests <span class="o">(</span>40% trivial<span class="o">)</span>.
</span></span><span class="line"><span class="cl">* Checking property <span class="s2">&#34;You cannot get paid all overtime, or all std time&#34;</span> ...
</span></span><span class="line"><span class="cl">*** Failed! Falsifiable after <span class="m">1</span> <span class="nb">test</span> and <span class="m">1</span> shrink <span class="k">for</span> input:
</span></span><span class="line"><span class="cl">  0: <span class="m">60</span>
</span></span><span class="line"><span class="cl">* Checking property <span class="s2">&#34;Not working overtime makes the math easy.&#34;</span> ...
</span></span><span class="line"><span class="cl">+++ OK, passed <span class="m">100</span> tests.
</span></span></code></pre></div><p>Argh! Still wrong? The property must be wrong. Notice that the properties are quite simple. No single test verifies the full range, but the properties provide useful documentation and make it easy to reason about the code. The properties are probably correct then. &hellip;yeah, it wasn&rsquo;t the property…</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">float</span> <span class="nf">payroll</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">size_t</span>  <span class="mi">5</span> <span class="p">,</span><span class="o">&gt;</span> <span class="n">person_id</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">hours</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">hours</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">out_of_range</span><span class="p">(</span><span class="s">&#34;Hours cannot be greater than 100&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">overtime</span> <span class="o">=</span> <span class="n">hours</span> <span class="o">-</span> <span class="mf">40.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">overtime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">hours</span> <span class="o">-</span> <span class="n">overtime</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">overtime</span> <span class="o">*</span> <span class="mi">15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">hours</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">* Checking property <span class="s2">&#34;Pay should be positive&#34;</span> ...
</span></span><span class="line"><span class="cl">+++ OK, passed <span class="m">100</span> tests <span class="o">(</span>40% trivial<span class="o">)</span>.
</span></span><span class="line"><span class="cl">* Checking property <span class="s2">&#34;You cannot get paid all overtime, or all std time&#34;</span> ...
</span></span><span class="line"><span class="cl">+++ OK, passed <span class="m">100</span> tests.
</span></span><span class="line"><span class="cl">* Checking property <span class="s2">&#34;Not working overtime makes the math easy.&#34;</span> ...
</span></span><span class="line"><span class="cl">+++ OK, passed <span class="m">100</span> tests.
</span></span></code></pre></div><p>I started this article wanting to post a simple tutorial on Property testing,
instead I learned to be a bit more careful using auto, and even when the
function is simple, programmers can make mistakes. For the final logic error,
the failing input was 60. Thinking about my directed test method, I would
divide the input into equivalence domains and test the boundary values. For
this input, I would divide standard time to the beginning of overtime. For
directed tests I would have written tests for: 0, 39, 40 41, 99, 100, and 101.
I would have missed the 60 hours bug, and there is the possibility that
I missed typed the numbers on my calculator and type in a wrong expected
value. This example is quite simple but still an interesting demonstration of
property testing. I&rsquo;m looking forward to applying property testing to my next
project.</p>
    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-123456789-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
