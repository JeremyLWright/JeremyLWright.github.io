<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.101.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://quiescent.us/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://quiescent.us/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://quiescent.us/favicon-16x16.png">

  
  <link rel="manifest" href="https://quiescent.us/site.webmanifest">

  
  <link rel="mask-icon" href="https://quiescent.us/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://quiescent.us/css/bootstrap.min.css" />

  
  <link rel="stylesheet" href="https://quiescent.us/css/syntax.css" />
  
  
  <title>Design by Refinement: Sorting by Refinement | The Quiescent Current</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/posts">Posts</a>
    
    <a href="/series">Series</a>
    
    <a href="/tags">Tags</a>
    
    <a href="/about">About</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Design by Refinement: Sorting by Refinement</h1>
<p>In the last posts we&rsquo;ve been studying refinement, and how to utilize refinement into a methodical approach to describe a system and a proposed solutions. Now let&rsquo;s apply it to a simple example, sorting.</p>
<p>This post has a paring with a video</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/U0GS_X2NVXk" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<h1 id="designing-sorting">Designing Sorting</h1>
<p>This article is intended to be paired with it&rsquo;s accompanying video.</p>
<p>Before we begin, let&rsquo;s think about what we want to accomplish:</p>
<ol>
<li>We want to express the essence of sorting. What is sorting? What is a definition such that <em>any</em> sorting algorithm can be shown to meet or conform to this abstract definition.</li>
<li>We want to express a specific algorithm, Bubble Sort, and show that it matches our abstract definition.</li>
</ol>
<p>Notice that each goal reflexively adds value to the other.</p>
<p>Goal 1 allows us to express the basic form of what &ldquo;sort&rdquo; means. This is design. We are thinking deeply about our system where we try to write down definitions that describe behaviors. When we eventually get to implementation, these invariants and properties can become properties for a QuickCheck-style test library.</p>
<p>Goal 2 allows us to see that a known algorithm implements our &ldquo;ideal&rdquo; sorting algorithm. Additionally, Goal 2 offers evidence that our abstract definition is right! This is actually the most important outcome. If your design is wrong, it doesn&rsquo;t matter if all your tests pass. Identifying that your abstraction and understanding of the abstraction is right is crucial!</p>
<p>Along the way we&rsquo;ll see how in this sorting example that between our abstract/idea definition and our implementable/detailed definition our start and end states are the same. This will be our refinement mapping relating the two systems&hellip; but let&rsquo;s not get ahead of ourselves. Let&rsquo;s work the process.</p>
<h3 id="what-is-our-goal">What is our goal</h3>
<blockquote>
<p>The outcome goal of this question is to identify the domain language of the problem.</p>
</blockquote>
<p>Given an input of values, I want an output of values in ascending order.</p>


  
    
  


<figure>
  <img
    src='https://g.gravizo.com/svg?%0a%20%20digraph%20G%20%7b%0a%20%20%20%20Start%20%5blabel%3d%22Start%5cn%5b7%2c3%2c8%2c1%5d%22%5d%0a%20%20%20%20Magic%0a%20%20%20%20End%20%5blabel%3d%22End%5cn%5b1%2c3%2c7%2c8%5d%22%5d%0a%0a%20%20%20%20Start%20-%3e%20Magic%0a%20%20%20%20Magic%20-%3e%20End%0a%20%20%7d%0a'
    alt='Ideal Sorting'
    />
    <figcaption>Ideal Sorting</figcaption>
</figure>

<h4 id="domain-language-definitions">Domain Language Definitions</h4>
<p>Sorted: Sorted values are values which are ordered in an ascending or descending order.</p>
<h3 id="what-properties-should-the-system-holdmaintain">What properties should the system hold/maintain</h3>
<blockquote>
<p>The outcome goal of this question is to identify the properties we should either maintain or conversely the properties we should never violate. In TLA+, these are our invariants and temporal properties. In Code, these are our generative tests.</p>
</blockquote>
<ol>
<li>Our sorting system should be resilient to an empty input. Empty inputs are already sorted.</li>
<li>Our sorting system should only sort finite sets.</li>
</ol>
<h3 id="what-actions-should-the-system-perform">What Actions should the system perform</h3>
<blockquote>
<p>The outcome goal of this question is to identify the verbs, the <em>somethings</em> that get done.</p>
</blockquote>
<ol>
<li>Our system performs a sort on an input.</li>
</ol>
<h3 id="what-is-a-proposed-solution">What is a proposed solution?</h3>
<blockquote>
<p>Notice that we haven&rsquo;t discussed how we will sort things. We didn&rsquo;t discuss specific sorting algorithms. We didn&rsquo;t discuss performance considerations such as time-complexity nor space-complexity. This is intentional. We are intentionally <strong>not</strong> discussing an implementation. We want to deal with the abstract directly. We want to express the ideals of our system before we get hamstrung by details of implementation, and the messy real world.</p>
</blockquote>
<p>Successively swap values until the input is sorted.</p>
<span class="image-container"><span class="link" ><a href="/img/rsd-02-refinement/relax.png" 
        target="_blank"><img class="img" src="/img/rsd-02-refinement/relax.png"/></a></span><span class="caption">
            <span class="title">Defining Sorting 2 Ways</span class="image-container-caption">
        </span>
</span>
<p>Notice that our proposed solution and the ideal solution share the same start and end states!</p>
<p>This is our refinement mapping! That&rsquo;s it!</p>
<ul>
<li>One system.</li>
<li>Described two ways.</li>
<li>Both ways share the same start and end states.</li>
<li>The middle states can change.</li>
</ul>
<h1 id="refinement-in-tla">Refinement in TLA+</h1>
<p>Let&rsquo;s work through the same process, this time expressing our goals in TLA+</p>
<h2 id="what-is-the-goal">What is the goal</h2>
<p>Given an input of values, I want an output of values in ascending order.</p>
<pre tabindex="0"><code>IsSortedAsc(seq) == \A a,b \in 1..N: a &lt; b =&gt; seq[a] &lt;= seq[b]
</code></pre><h2 id="what-are-the-properties-you-want-the-system-to-holdmaintain">What are the properties you want the system to hold/maintain</h2>
<pre tabindex="0"><code>EventuallySortedAsc == &lt;&gt;[]IsSortedAsc(A) \* Always, eventually the input is sorted
InputSizeDoesntChange == Len(A) = N \* The Input is always the same length, e.g., we cannot sort by throwing away the input.
</code></pre><h2 id="what-are-the-actions-you-want-the-system-to-perform">What are the actions you want the system to perform</h2>
<pre tabindex="0"><code>SortByMagic(seq) == CHOOSE p \in Shuffle(seq) : IsSortedAsc(p) \* Given all shuffled inputs, pick the sorted one.
</code></pre><h3 id="how-do-we-shuffle-in-tla">How do we shuffle in TLA+?</h3>
<pre tabindex="0"><code>ApplyIndices(seq, indices) == [ i \in 1..Len(seq) |-&gt; seq[indices[i]]]
Shuffle(seq) == {ApplyIndices(seq, p) : p \in Permutations(1..Len(seq))}
</code></pre><h2 id="what-is-a-proposed-solution-1">What is a proposed solution?</h2>
<p>Now we have our ideal system. We checked our invariants. Let&rsquo;s try to implement BubbleSort in the algorithm dialect of TLA+, PlusCal.</p>
<pre tabindex="0"><code>(*--fair algorithm BubbleSort {
    variables A \in [1..N -&gt; Int], A0 = A, i = 1, j = 1, totalSteps = 0;
    { while (i &lt; N) {
        j := i + 1;
        while (j &gt; 1 /\ A[j - 1] &gt; A[j]) {
            A[j-1] := A[j] || A[j] := A[j - 1];
            j := j - 1;
            totalSteps := totalSteps + 1;
        };
        i := i + 1;
        totalSteps := totalSteps + 1;
    };
    }
}
*)
</code></pre><p>Finally, we can check correspondence between our two definitions:</p>
<pre tabindex="0"><code>Mapping == 
    INSTANCE sort WITH 
        \* magic sort side &lt;- bubble sort side
        A &lt;- IF pc = &#34;Done&#34; THEN A ELSE A0

Refinement == Mapping!Spec
</code></pre><h1 id="references">References</h1>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-123456789-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
