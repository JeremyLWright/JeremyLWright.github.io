<!DOCTYPE html>
<html lang="en"><meta charset="utf-8"><meta name="generator" content="Hugo 0.97.3" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><title>Making C&#43;&#43; like Python: The Anderson Smart Pointer Pattern&nbsp;&ndash;&nbsp;The Quiescent Current</title><link rel="stylesheet" href="/css/core.min.6794bc167e4ce0026d21831c61e605e88a70ef6cc11b090df06de3ed8be76f69afa57c9dcd7ba7210c777e124e943258.css" integrity="sha384-Z5S8Fn5M4AJtIYMcYeYF6Ipw72zBGwkN8G3j7Yvnb2mvpXydzXunIQx3fhJOlDJY"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Making C&#43;&#43; like Python: The Anderson Smart Pointer Pattern" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/"><span class="site name">The Quiescent Current</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/tags/">Tags</a><a class="nav item" href="/posts">Blog</a><a class="nav item" href="/series">Series</a><a class="nav item" href="/languages">Languages</a><a class="nav item" href="/about">About</a></nav></div></span></div><div class="site slogan"><span class="title">Go Far. Go Together.</span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">Making C++ like Python: The Anderson Smart Pointer Pattern</h1><p class="article date">Sunday, October 23, 2011</p></section><article class="article markdown-body"><p>Choosing to use C++ brings the additional complexity of memory management.  Dennis Ritchie once stated: The C Programming Language — A language which combines the flexibility of assembly language with the power of assembly language. C++ inherits much of that _flexibility, _however, this <a href="http://www.infoq.com/presentations/Are-We-There-Yet-Rich-Hickey"target="_blank" rel="noopener noreferrer">incidental complexity</a>
, can be relegated to a single class, leaving you with the high-level elegance of Python. RAII help with this additional complexity, however without a pattern for guidance implementing RAII consistently can be difficult, defeating the safety it provides.</p>
<p>Resource Acquisition Is Initialization (<a href="http://en.wikipedia.org/wiki/Resource_Acquisition_Is_Initialization"target="_blank" rel="noopener noreferrer">RAII</a>
) is a powerful tool for managing resources.  RAII <a href="http://www.research.att.com/~bs/bs_faq2.html#finally"target="_blank" rel="noopener noreferrer">justifies</a>
 the apparent missing finally clause. Stroustrup claims that with proper RAII,  <a href="http://www.research.att.com/~bs/bs_faq2.html#finally"target="_blank" rel="noopener noreferrer">finally</a>
 is not required. D also <a href="http://www.d-programming-language.org/exception-safe.html"target="_blank" rel="noopener noreferrer">implements</a>
 RAII with scope operators. Ok, so RAII is powerful, but what is it?</p>
<p>In C++, destructors are the only entity guaranteed to execute after an exception.  So resources which need to be automatically reclaimed need  to acquire at initialization, and release at destruction.  Such resources must be declared on the stack, to permit this idiom.</p>
<p>Writing exception-safe code, e.g. managing resources throughout exceptions is difficult, and while RAII makes it easier, managing RAII correctly is difficult without a pattern. A colleague of mine, <a href="http://www.chrisanderman.com/"target="_blank" rel="noopener noreferrer">Anderson</a>
, developed a fantastic pattern/<a href="http://erdani.com/publications/cuj-2005-12.pdf"target="_blank" rel="noopener noreferrer">policy</a>
 using smart pointers which makes RAII automatic.</p>
<p>Two patterns compose the Anderson Smart Pointer Pattern: Factory Constructor, and PIMPL.</p>
<pre><code>#ifdef _WIN
#include &lt;memory&gt;
#else
#include &lt;tr1/memory&gt;
#endif

class Name
{
public:
#ifdef _WIN
    typedef std::shared_ptr Ptr; //This uses the class as a namespace.
    typedef std::weak_ptr WeakPtr;
#else
    typedef std::tr1::shared_ptr Ptr;
    typedef std::tr1::weak_ptr WeakPtr;
#endif
    static name::Ptr construct(); //Factory Constructor
    virtual ~name();
private:
    Name(); //Notice the constructor is private
    name::WeakPtr self; //self (from python), replaces this
};

Name::Ptr Name::construct()
{
    Name::Ptr c(new Name());
    //Self completes the PIMPL idiom,
    //thereby hiding all behavior behind a safe, reference counted wall
    c-&gt;self = c;
    return c;
}
</code></pre>
<p>This pattern is used as an RAII <a href="http://erdani.com/publications/cuj-2005-12.pdf"target="_blank" rel="noopener noreferrer">policy</a>
. Using the pattern liberally can eliminate new and delete from your program, and you will not leak memory. Even with multiple exceptions, you&rsquo;re <a href="https://bitbucket.org/jwright/cse310-red-black-tree/overview"target="_blank" rel="noopener noreferrer">program will not leak</a>
.  Creating an instance of an RAII class is easy now:</p>
<pre><code>Name::Ptr myInstance = Name::construct();
</code></pre>
<p>This Pattern will make one extra virtual call as it performs the reference counting, but the performance hit is typically nominal compared to the safety it provides to the system. The Anderson Smart-Pointer Pattern increases robustness of your programs, but interestingly it also provides a new elegance. Since one is not managing memory, and resources constantly, it makes C++ perform more like a high level language. For example, I implemented a <a href="https://bitbucket.org/jwright/cse310-red-black-tree/src/d787e75b724a/BaseCode/RedBlackTree.cpp#cl-137"target="_blank" rel="noopener noreferrer">red black tree</a>
 using this pattern.  I didn&rsquo;t need to worry about deleting nodes, just the requirements of my program. With the incidental complexity relegated to a single class, I am left with the elegant, expressiveness of Python, yet retain the raw performance of C++.</p></article><section class="article labels"><a class="tag" href=/tags/coding/>Coding</a><a class="tag" href=/tags/memory/>memory</a><a class="tag" href=/tags/python/>Python</a><a class="tag" href=/tags/raii/>RAII</a></section><div class="article share addthis_inline_share_toolbox"></div><script defer src="/js/addthis_widget.min.26acbe1a2ce9f782f6bbf368cc6d28f1d234a8ab8310cbcbb6eb69dcd155f2067db37beaa642aedf370075d14d02d307.js#pubid=ra-1234567890" integrity="sha384-Jqy&#43;Gizp94L2u/NozG0o8dI0qKuDEMvLtutp3NFV8gZ9s3vqpkKu3zcAddFNAtMH"></script>
</div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/2011/11/parallel-binary-buddy-the-friendly-memory-manager/"><span class="iconfont icon-article"></span>Parallel Binary Buddy: The Friendly Memory Manager</a></p><p><a class="link" href="/2011/10/parallel-game-of-life/"><span class="iconfont icon-article"></span>Parallel Game-of-Life</a></p></section><section class="article discussion"><div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "codestrokes2" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">©2021 Jeremy Wright</p>
    <p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div>
</section><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/&#43;DiW/UqRcLbRjq" crossorigin="anonymous"><script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l&#43;B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd&#43;qj&#43;o24G5ZU2zJz" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
            onload="renderMathInElement(document.body);"></script></body>

</html>